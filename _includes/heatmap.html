<div id="heatmap" style="width:100%;height:220px;"></div>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script>
  const chartDom = document.getElementById('heatmap');
  const myChart = echarts.init(chartDom);

  // Responsive sizing
  function resizeChart() {
    const w = chartDom.parentElement.offsetWidth - 40; // minus padding
    chartDom.style.width = w + 'px';
    myChart.resize();
  }
  window.addEventListener('resize', resizeChart);
  setTimeout(resizeChart, 100);

  // ---- build data from ALL posts (not paginator) ----
  // dataMap: { 'YYYY-MM-DD' -> { wordCount, link, title } }
  const dataMap = new Map();

  {% assign all_posts = site.posts %}
  {%- comment -%} If you're on Jekyll 4 with collections: use site.collections.posts.docs {%- endcomment -%}
  {%- if site.collections and site.collections.posts and site.collections.posts.docs -%}
    {% assign all_posts = site.collections.posts.docs %}
  {%- endif -%}

  {% assign first_date = nil %}
  {% for post in all_posts %}
    {% assign day = post.date | date: "%Y-%m-%d" %}
    {% comment %}
      Compute a rough "thousands of words" value. Replace with your own word counter if you have one:
      e.g. post.content | number_of_words | divided_by: 1000.0
    {% endcomment %}
    {% assign words = post.content | number_of_words %}
    {% assign kwords = words | plus: 0.0 | divided_by: 1000.0 %}
    (function() {
      var key = "{{ day }}";
      var existing = dataMap.get(key);
      var wordCount = {{ kwords | round: 1 | default: 0 }};
      var link = "{{ post.url | relative_url }}";
      var title = {{ post.title | jsonify }};
      // keep only the longest post per day
      if (!existing || wordCount > existing.wordCount) {
        dataMap.set(key, { wordCount, link, title });
      }
    })();
    {% if forloop.last == false %}
      {% if first_date == nil or post.date < first_date %}
        {% assign first_date = post.date %}
      {% endif %}
    {% endif %}
  {% endfor %}

  // convert to ECharts data array
  const data = [];
  for (const [key, val] of dataMap.entries()) {
    data.push([key, val.wordCount]);
  }

  // ---- date range ----
  // Use full history (first post -> today). Fallback to last 12 months if unknown.
  function pad2(n){ return (n<10?'0':'')+n; }
  function fmt(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()); }

  let startStr = "{{ first_date | date: '%Y-%m-%d' }}";
  if (!startStr || startStr === "") {
    const d = new Date();
    d.setFullYear(d.getFullYear() - 1);
    startStr = fmt(d);
  }
  const endStr = fmt(new Date());

  // If you want the responsive “last 6/9/12 months” view, use this instead:
  function rangeByWidth() {
    const w = chartDom.parentElement.offsetWidth - 40;
    const months = w >= 600 ? 12 : (w >= 400 ? 9 : 6);
    const end = new Date();
    const start = new Date(end);
    start.setMonth(start.getMonth() - months);
    return [fmt(start), fmt(end)];
  }
  // Choose one of the following lines:
  // const range = [startStr, endStr]; // full history
  const range = [startStr, endStr];        // 全历史窗口

  // visual max based on your data (cap to something reasonable)
  const maxVal = Math.max(1, ...data.map(d => d[1] || 0));
  const vizMax = Math.max(5, Math.ceil(maxVal));

  const option = {
    title: { top: 0, left: 'center', text: '博客创作热力图' },
    tooltip: {
      formatter: function (p) {
        const post = dataMap.get(p.data[0]);
        if (!post) return p.data[0] + ' | 0 千字';
        return (post.title || '无标题') + ' | ' + (post.wordCount || 0) + ' 千字';
      }
    },
    visualMap: {
      min: 0,
      max: vizMax,
      type: 'piecewise',
      orient: 'horizontal',
      left: 'center',
      top: 30,
      inRange: { color: ['#7aa8744c', '#7AA874'] },
      splitNumber: 4,
      text: ['千字', ''],
      showLabel: true,
      itemGap: 20
    },
    calendar: {
      top: 80, left: 20, right: 20, bottom: 10,
      cellSize: ['auto', 12],
      range: range, // IMPORTANT: not nested
      itemStyle: { color: '#F1F1F1', borderWidth: 2.5, borderColor: '#fff' },
      yearLabel: { show: false },
      splitLine: { lineStyle: { color: 'rgba(0,0,0,0.0)' } }
    },
    dayLabel: { nameMap: ['日', '一', '二', '三', '四', '五', '六'] },
    series: {
      type: 'heatmap',
      coordinateSystem: 'calendar',
      data: data
    }
  };

  myChart.setOption(option);
  resizeChart();

  // Click to open post
  myChart.on('click', function(params) {
    if (params.componentType === 'series') {
      const post = dataMap.get(params.data[0]);
      if (post && post.link) window.open(post.link, '_blank');
    }
  });
</script>
